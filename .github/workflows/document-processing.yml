
name: ðŸ“„ Document Processing Pipeline

on:
  workflow_dispatch:
    inputs:
      process_type:
        description: 'Processing type to run'
        required: true
        default: 'full_pipeline'
        type: choice
        options:
          - full_pipeline
          - ppt_only
          - recursive_build_only
          - metadata_extraction
  push:
    paths:
      - 'app/public/master_input/**'
      - 'scripts/**'

jobs:
  document-processing:
    name: ðŸ”„ Run Document Processing
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Processing Dependencies
        run: |
          pip install pathlib datetime hashlib json re
          echo "Processing dependencies installed"

      - name: ðŸ”„ Run Full Processing Pipeline
        if: github.event.inputs.process_type == 'full_pipeline' || github.event.inputs.process_type == ''
        run: |
          cd scripts
          echo "ðŸš€ Starting complete document processing pipeline..."
          python run_processing.py
          python recursive_build.py
          echo "âœ… Complete pipeline processing finished!"

      - name: ðŸ“„ PPT Processing Only
        if: github.event.inputs.process_type == 'ppt_only'
        run: |
          cd scripts  
          echo "ðŸ”„ Running PowerPoint processing only..."
          python ppt_processor.py
          echo "âœ… PPT processing completed!"

      - name: ðŸ—ï¸ Recursive Build Only
        if: github.event.inputs.process_type == 'recursive_build_only'
        run: |
          cd scripts
          echo "ðŸ—ï¸ Running recursive build system..."
          python recursive_build.py
          echo "âœ… Recursive build completed!"

      - name: ðŸ“Š Generate Processing Report
        run: |
          echo "=== ðŸ“Š Processing Report ==="
          echo "â° Processing completed: $(date)"
          echo "ðŸ“ Digital twins: $(find app/public/outputs/digital_twins -name "*.md" | wc -l 2>/dev/null || echo 'N/A')"
          echo "ðŸ“Š Metadata files: $(find app/public/outputs/metadata -name "*.json" | wc -l 2>/dev/null || echo 'N/A')"
          echo "ðŸ”— Cross-references: $(find app/public/outputs/cross_references -name "*.json" | wc -l 2>/dev/null || echo 'N/A')"
          echo "ðŸ—ï¸ Recursive build: $(ls app/public/outputs/recursive_build/ 2>/dev/null | wc -l || echo 'N/A') files"

      - name: ðŸ’¾ Commit Processed Files
        if: github.event_name == 'push'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add app/public/outputs/
          git diff --staged --quiet || git commit -m "ðŸ¤– Automated document processing

          - Updated digital twins and metadata
          - Refreshed cross-reference mappings  
          - Rebuilt recursive navigation system
          - Processing completed: $(date)"
          git push || echo "No changes to push"
